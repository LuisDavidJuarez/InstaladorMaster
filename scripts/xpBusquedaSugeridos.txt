CREATE PROC [dbo].[xpBusquedaSugeridos]
	@sucursal INT,
	@texto varchar(50)
AS BEGIN
    -- Obtener Region de la Sucursal
	DECLARE @region VARCHAR(30),
		    @condicion VARCHAR(50),
			@empresa VARCHAR(5),
			@cliente VARCHAR(20) = NULL
	
	DECLARE @Arts TABLE (Articulo VARCHAR(20))
	DECLARE @tbl_Consulta TABLE (Codigo VARCHAR(20), Gen_Pat VARCHAR(1), Articulo VARCHAR(20), Descripcion1 VARCHAR(100), PrecioLista MONEY, 
								 Precio2 MONEY, Familia VARCHAR(50), DescuentosCascada FLOAT, EnSucursal INT, PoliticaExclusiva BIT, 
								 ID INT, Tipo VarChar(23), Estatus VARCHAR(20), SustanciaActiva VARCHAR(100), PrecioConDescuento MONEY)
	DECLARE @tbl_Consulta_Final TABLE (Codigo VARCHAR(20), Gen_Pat VARCHAR(1), Articulo VARCHAR(20), Descripcion1 VARCHAR(100), PrecioLista MONEY, 
									   Precio2 MONEY,  Familia VARCHAR(50), DescuentosCascada FLOAT, EnSucursal INT, PoliticaExclusiva BIT, 
									   ID INT, Tipo VarChar(23), PrecioConDescuento MONEY, Estatus VARCHAR(20), SustanciaActiva VARCHAR(100), 
									   Cantidad FLOAT, Monto MONEY, IVA FLOAT, IEEPS FLOAT, Costo MONEY)
       
	SELECT @region = Region, @condicion = NULL, @empresa = 'OFB'
	  FROM Sucursal WITH (NOLOCK) 
	 WHERE Sucursal = @sucursal
		
	IF @cliente IN ('','NULL') SELECT @cliente = NULL
    
	DECLARE @SustanciaActiva VARCHAR(40),
			@Unidad VARCHAR(10)

	--Extraigo la Sustancia Activa y la Unidad de Medida del Artículo Seleccionado
	SELECT @SustanciaActiva = SustanciaActiva,@Unidad = UPPER(Unidad)
	  FROM Art WITH (NOLOCK)
	 WHERE Articulo = @texto

	--Genero una tabla con todos los artículos que tengan Sustancia Activa y que el grupo no este en CADUCADO
	DECLARE @ArtSustanciaActiva TABLE (Articulo VARCHAR(20), SustanciaActiva VARCHAR(100), Unidad VARCHAR(10))
	INSERT INTO @ArtSustanciaActiva (Articulo,SustanciaActiva,Unidad)
	SELECT Articulo,
		   SUBSTRING(A.SustanciaActiva 
				,LEN(A.SustanciaActiva) - (LEN(LTRIM(REPLACE(A.SustanciaActiva, '"', ' ')) + '|') - 1) + 1 --start_pos
				,LEN(LTRIM(REPLACE(A.SustanciaActiva, '"', ' '))) --length
		   ) AS SustanciaActiva,
		   Unidad
	  FROM Art AS A WITH(NOLOCK)
	 WHERE A.SustanciaActiva != ''
	   AND Grupo NOT IN('CADUCADO')

	--Obtengo solo los artículos que tienen la Sustancia Activa similar y la Unidad de Medida igual al Artículo seleccionado
	INSERT INTO @Arts
	SELECT Articulo
	  FROM @ArtSustanciaActiva
	 WHERE SustanciaActiva LIKE '%' + @SustanciaActiva + '%'
	   AND UPPER(Unidad) = @Unidad

    -- InfoBusqueda Articulo        
    IF EXISTS(SELECT * FROM @Arts)
    BEGIN
		INSERT INTO @tbl_Consulta
        SELECT x.*, (x.PrecioLista*(100-x.DescuentosCascada))/100 as PrecioConDescuento
        FROM
        (
        SELECT  '' AS Codigo,
                CASE WHEN Art.Familia LIKE '%GENERICO%' THEN 'G'
                        ELSE
                                CASE WHEN Art.Familia LIKE '%PATENTE%' THEN 'P'
                                ELSE NULL END
                END AS Gen_Pat,
                Art.Articulo AS Articulo, 
				Art.Descripcion1 AS Descripcion1,
                Art.PrecioLista AS PrecioLista,
                Art.Precio2 AS Precio2,
                Art.Familia AS Familia,
                ROUND(dbo.fnListaDescuentos(REPLACE((SELECT CONVERT(varchar,monto) as [data()]
                                        FROM Precio P WITH (NOLOCK) INNER JOIN PrecioD D WITH (NOLOCK) ON P.ID = D.ID
                                        WHERE P.Estatus = 'ACTIVA'
										AND (P.ConVigencia = 0  OR (P.ConVigencia = 1   AND GETDATE() BETWEEN P.FechaD AND P.FechaA))
										AND (P.NivelEmpresa=0   OR (P.NivelEmpresa=1    AND P.Empresa = @empresa))
										--AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = @Articulo))
										AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = Art.Articulo))
										AND (P.NivelArtGrupo=0  OR (P.NivelArtGrupo=1   AND P.ArtGrupo = Art.Grupo))
										AND (P.NivelArtCat=0    OR (P.NivelArtCat=1     AND P.ArtCat = Art.Categoria))
										AND (P.NivelArtFam=0    OR (P.NivelArtFam=1     AND P.ArtFam = Art.Familia))
										AND (P.NivelArtLinea=0  OR (P.NivelArtLinea=1   AND P.ArtLinea = Art.Linea))
										AND (P.NivelSucursal=0  OR (P.NivelSucursal=1   AND P.Sucursal = @sucursal))
                                        AND (P.NivelRegion=0    OR (P.NivelRegion=1     AND P.Region = @region))
										AND (P.NivelCliente=0   OR (P.NivelCliente=1    AND P.Cliente = @cliente ))
										AND (P.NivelCondicion=0 OR (P.NivelCondicion=1  AND Condicion = @condicion))
										AND P.ListaPrecios IN ('1','2','Todas')
										AND P.Nivel = 'Normal'
										AND P.Tipo IN ('% Descuento','Precio=Precio 2+[%]')
                                        FOR XML PATH ('')
                                        ), ' ', ','),','),2) as DescuentosCascada,
                0 as EnSucursal,
                ISNULL((					SELECT	TOP 1 1
                                        FROM Precio P WITH (NOLOCK) INNER JOIN PrecioD D WITH (NOLOCK) ON P.ID = D.ID
                                        WHERE P.Estatus = 'ACTIVA'
										AND (P.ConVigencia = 0  OR (P.ConVigencia = 1   AND GETDATE() BETWEEN P.FechaD AND P.FechaA))
										AND (P.NivelEmpresa=0   OR (P.NivelEmpresa=1    AND P.Empresa = @empresa))
										--AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = @Articulo))
										AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = Art.Articulo))
										AND (P.NivelArtGrupo=0  OR (P.NivelArtGrupo=1   AND P.ArtGrupo = Art.Grupo))
										AND (P.NivelArtCat=0    OR (P.NivelArtCat=1     AND P.ArtCat = Art.Categoria))
										AND (P.NivelArtFam=0    OR (P.NivelArtFam=1     AND P.ArtFam = Art.Familia))
										AND (P.NivelArtLinea=0  OR (P.NivelArtLinea=1   AND P.ArtLinea = Art.Linea))
										AND (P.NivelSucursal=0  OR (P.NivelSucursal=1   AND P.Sucursal = @sucursal))
                                        AND (P.NivelRegion=0    OR (P.NivelRegion=1     AND P.Region = @region))
										AND (P.NivelCliente=0   OR (P.NivelCliente=1    AND P.Cliente = @cliente ))
										AND (P.NivelCondicion=0 OR (P.NivelCondicion=1  AND Condicion = @condicion))
										AND P.ListaPrecios IN ('1','2','Todas')
										AND P.Nivel <> 'Normal'
										/*AND P.Tipo = '% Descuento'*/), 0) PoliticaExclusiva,
            --   0 Cant, 0 Monto,
										(SELECT	TOP 1 P.ID
                                        FROM Precio P WITH (NOLOCK) INNER JOIN PrecioD D WITH (NOLOCK) ON P.ID = D.ID
                                        WHERE P.Estatus = 'ACTIVA'
										AND (P.ConVigencia = 0  OR (P.ConVigencia = 1   AND GETDATE() BETWEEN P.FechaD AND P.FechaA))
										AND (P.NivelEmpresa=0   OR (P.NivelEmpresa=1    AND P.Empresa = @empresa))
										--AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = @Articulo))
										AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = Art.Articulo))
										AND (P.NivelArtGrupo=0  OR (P.NivelArtGrupo=1   AND P.ArtGrupo = Art.Grupo))
										AND (P.NivelArtCat=0    OR (P.NivelArtCat=1     AND P.ArtCat = Art.Categoria))
										AND (P.NivelArtFam=0    OR (P.NivelArtFam=1     AND P.ArtFam = Art.Familia))
										AND (P.NivelArtLinea=0  OR (P.NivelArtLinea=1   AND P.ArtLinea = Art.Linea))
										AND (P.NivelSucursal=0  OR (P.NivelSucursal=1   AND P.Sucursal = @sucursal))
                                        AND (P.NivelRegion=0    OR (P.NivelRegion=1     AND P.Region = @region))
										AND (P.NivelCliente=0   OR (P.NivelCliente=1    AND P.Cliente = @cliente ))
										AND (P.NivelCondicion=0 OR (P.NivelCondicion=1  AND Condicion = @condicion))
										AND P.ListaPrecios IN ('1','2','Todas')
										AND P.Nivel <> 'Normal' ORDER BY P.ID) ID,
										(SELECT	TOP 1 P.Tipo
                                        FROM Precio P WITH (NOLOCK) INNER JOIN PrecioD D WITH (NOLOCK) ON P.ID = D.ID
                                        WHERE P.Estatus = 'ACTIVA'
										AND (P.ConVigencia = 0  OR (P.ConVigencia = 1   AND GETDATE() BETWEEN P.FechaD AND P.FechaA))
										AND (P.NivelEmpresa=0   OR (P.NivelEmpresa=1    AND P.Empresa = @empresa))
										--AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = @Articulo))
										AND (P.NivelArticulo=0  OR (P.NivelArticulo=1   AND P.Articulo = Art.Articulo))
										AND (P.NivelArtGrupo=0  OR (P.NivelArtGrupo=1   AND P.ArtGrupo = Art.Grupo))
										AND (P.NivelArtCat=0    OR (P.NivelArtCat=1     AND P.ArtCat = Art.Categoria))
										AND (P.NivelArtFam=0    OR (P.NivelArtFam=1     AND P.ArtFam = Art.Familia))
										AND (P.NivelArtLinea=0  OR (P.NivelArtLinea=1   AND P.ArtLinea = Art.Linea))
										AND (P.NivelSucursal=0  OR (P.NivelSucursal=1   AND P.Sucursal = @sucursal))
                                        AND (P.NivelRegion=0    OR (P.NivelRegion=1     AND P.Region = @region))
										AND (P.NivelCliente=0   OR (P.NivelCliente=1    AND P.Cliente = @cliente ))
										AND (P.NivelCondicion=0 OR (P.NivelCondicion=1  AND Condicion = @condicion))
										AND P.ListaPrecios IN ('1','2','Todas')
										AND P.Nivel <> 'Normal' ORDER BY P.ID) Tipo,
										Art.Estatus AS Estatus, Art.SustanciaActiva AS SustanciaActiva
         FROM Art WITH (NOLOCK)
        WHERE Art.Articulo IN (SELECT Articulo FROM @Arts)
        ) AS x
            
		INSERT @tbl_Consulta_Final(Codigo,Gen_Pat,Articulo,Descripcion1,PrecioLista,Familia,DescuentosCascada,EnSucursal,
			   PoliticaExclusiva,ID,Tipo,PrecioConDescuento,Cantidad,Monto,Costo,Estatus,SustanciaActiva)
		SELECT (SELECT MAX(RTRIM(CB.Codigo)) FROM CB WHERE CB.Cuenta = C.Articulo) AS Codigo, Gen_Pat, C.Articulo, Descripcion1, 
			   CASE WHEN Tipo = 'Precio=Precio 2+[%]' THEN Precio2 ELSE PrecioLista END AS PrecioLista, Familia, DescuentosCascada,
			   EnSucursal, PoliticaExclusiva, C.ID , Tipo,
			   CASE WHEN PoliticaExclusiva=1 AND C.Tipo = 'Precio' THEN PD.Monto 
					ELSE (CASE WHEN PoliticaExclusiva = 1 AND C.Tipo = 'Precio=Precio 2+[%]' THEN (Precio2 - (Precio2 * ABS(PD.Monto)/100)) 
							   ELSE PrecioConDescuento 
						  END)
				    END PrecioConDescuento,
			   ISNULL(PD.Cantidad,1) Cantidad, 
			   ABS(PD.Monto) Monto, 0 AS Costo, 
			   C.Estatus AS Estatus, C.SustanciaActiva AS SustanciaActiva
		  FROM @tbl_Consulta C 
		  LEFT JOIN PrecioD PD WITH (NOLOCK) ON C.ID = PD.ID AND C.PoliticaExclusiva = 1 AND C.Tipo IN ('Precio','Precio=Precio 2+[%]')
		-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		DECLARE @ZonaImpuesto VARCHAR(30),@Porcentaje FLOAT,@IVA FLOAT,@IEEPS FLOAT,@PrecioListaIEEPS MONEY,@PrecioListaIVA MONEY

		SELECT @ZonaImpuesto = ZonaImpuesto FROM Sucursal WHERE Sucursal = @sucursal
		SELECT @Porcentaje   = (Porcentaje/100) + 1 FROM ZonaImp WHERE Zona = @ZonaImpuesto
		
		UPDATE T SET T.IVA   = O.Impuesto1,
		             T.IEEPS = O.Impuesto2
		  FROM @tbl_Consulta_Final AS T
		 INNER JOIN Art AS O ON T.Articulo = O.Articulo

		UPDATE @tbl_Consulta_Final SET PrecioLista        = CASE WHEN IEEPS > 0 THEN (PrecioLista  * ((IEEPS/100) + 1)) ELSE PrecioLista END
		UPDATE @tbl_Consulta_Final SET PrecioConDescuento = CASE WHEN IEEPS > 0 THEN (PrecioConDescuento  * ((IEEPS/100) + 1)) ELSE PrecioConDescuento END
		UPDATE @tbl_Consulta_Final SET PrecioLista        = CASE WHEN IVA   > 0 THEN (PrecioLista  * @Porcentaje)  ELSE PrecioLista END
		UPDATE @tbl_Consulta_Final SET PrecioConDescuento = CASE WHEN IVA   > 0 THEN (PrecioConDescuento  * @Porcentaje)  ELSE PrecioConDescuento END

		--Resultado de los Sugeridos
		SELECT Codigo,A.Articulo,Descripcion1 AS Descripcion,Costo,PrecioLista AS Precio,DescuentosCascada AS Descuento,PrecioConDescuento,
			  'n/a' AS Margen,'n/a' AS Existencia,Gen_Pat,Familia, Estatus, SustanciaActiva
		  FROM @tbl_Consulta_Final AS A
		 ORDER BY Estatus,Descripcion DESC
	   	-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    END
	ELSE 
	BEGIN
		SELECT *, 0.0 Cantidad, 0.0 Monto FROM @tbl_Consulta
	END
END